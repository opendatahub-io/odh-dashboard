# ---------- Development Dockerfile for Frontend ----------
# This Dockerfile is optimized for Tilt live_update development.
# It runs webpack-dev-server with hot module replacement (HMR).
#
# Build context: workspaces/frontend/
#
# Environment is configured via DEV_ENV=tilt which sets up appropriate
# defaults for development. Container-specific overrides are set below.

FROM node:20-slim

# Create app directory with correct ownership, then switch to non-root user
RUN mkdir /app && chown 1000:1000 /app
USER 1000:1000
WORKDIR /app

# Copy package files first for better layer caching
# chmod=777 allows Tilt live_update to write files without CAP_CHOWN
COPY --chmod=777 package*.json ./

# Install dependencies
# Using npm ci for reproducible builds, but falling back to npm install
# if package-lock.json is out of sync during development
RUN npm ci || npm install

# Copy source code and configuration
COPY --chmod=777 . ./

# Expose the webpack dev server port (matches production deployment)
EXPOSE 8080

# Container networking: listen on all interfaces
ENV HOST=0.0.0.0

# Start webpack dev server with hot reload
# start:tilt sets DEV_ENV=tilt which configures webpack for development mode
CMD ["npm", "run", "start:tilt"]
