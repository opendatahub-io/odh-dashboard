#!/usr/bin/env sh

echo "üîç Checking for lint errors in staged files..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Filter staged files by directory and file type
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep "^frontend/" | grep -E "\.(js|ts|jsx|tsx)$" || true)
BACKEND_FILES=$(echo "$STAGED_FILES" | grep "^backend/" | grep -E "\.(js|ts|json)$" || true)

# Exit early if no relevant files are staged
if [ -z "$FRONTEND_FILES" ] && [ -z "$BACKEND_FILES" ]; then
    echo "‚úÖ No frontend or backend files staged for commit, skipping lint checks"
    exit 0
fi

# Track if any linting failed
LINT_FAILED=0

# Run frontend lint on specific staged files
if [ -n "$FRONTEND_FILES" ]; then
    echo "üìù Linting staged frontend files:"
    echo "$FRONTEND_FILES" | sed 's/^/  - /'
    cd frontend
    
    # Convert file paths to be relative to frontend directory and check they exist
    FRONTEND_FILES_RELATIVE=""
    for file in $FRONTEND_FILES; do
        RELATIVE_FILE=$(echo "$file" | sed 's|^frontend/||')
        if [ -f "$RELATIVE_FILE" ]; then
            FRONTEND_FILES_RELATIVE="$FRONTEND_FILES_RELATIVE $RELATIVE_FILE"
        fi
    done
    
    if [ -n "$FRONTEND_FILES_RELATIVE" ]; then
        if ! npx eslint --max-warnings 0 $FRONTEND_FILES_RELATIVE; then
            echo "‚ùå Frontend lint failed!"
            LINT_FAILED=1
        else
            echo "‚úÖ Frontend lint passed!"
        fi
    fi
    cd ..
fi

# Run backend lint on specific staged files  
if [ -n "$BACKEND_FILES" ]; then
    echo "üìù Linting staged backend files:"
    echo "$BACKEND_FILES" | sed 's/^/  - /'
    cd backend
    
    # Convert file paths to be relative to backend directory and check they exist
    BACKEND_FILES_RELATIVE=""
    for file in $BACKEND_FILES; do
        RELATIVE_FILE=$(echo "$file" | sed 's|^backend/||')
        if [ -f "$RELATIVE_FILE" ]; then
            BACKEND_FILES_RELATIVE="$BACKEND_FILES_RELATIVE $RELATIVE_FILE"
        fi
    done
    
    if [ -n "$BACKEND_FILES_RELATIVE" ]; then
        if ! npx eslint --max-warnings 0 $BACKEND_FILES_RELATIVE; then
            echo "‚ùå Backend lint failed!"
            LINT_FAILED=1
        else
            echo "‚úÖ Backend lint passed!"
        fi
    fi
    cd ..
fi

# Exit with error if any lint check failed
if [ $LINT_FAILED -eq 1 ]; then
    echo "üí• Commit aborted due to lint errors. Please fix the issues and try again."
    echo "üí° You can run 'npx eslint --fix <file>' to auto-fix some issues."
    exit 1
fi

echo "üéâ All lint checks passed!"
exit 0 