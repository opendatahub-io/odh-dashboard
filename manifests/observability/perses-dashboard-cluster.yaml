apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  name: dashboard-0-cluster-admin
spec:
  display:
    name: Cluster
  duration: 1h
  # Variable for namespace filtering - controlled by HeaderProjectSelector
  variables:
    - kind: TextVariable
      spec:
        name: namespace
        display:
          name: Namespace
          hidden: true  # Hide from Perses UI since we use our own selector
        value: ".*"  # Default: match all namespaces
    # Cluster details variables - set by ClusterDetailsVariablesProvider
    - kind: TextVariable
      spec:
        name: CLUSTER_DETAILS_API_SERVER
        display:
          name: API server
          hidden: true
        value: "N/A"
    - kind: TextVariable
      spec:
        name: CLUSTER_DETAILS_CHANNEL
        display:
          name: Channel
          hidden: true
        value: "N/A"
    - kind: TextVariable
      spec:
        name: CLUSTER_DETAILS_OPENSHIFT_VERSION
        display:
          name: OpenShift version
          hidden: true
        value: "N/A"
    - kind: TextVariable
      spec:
        name: CLUSTER_DETAILS_INFRASTRUCTURE_PROVIDER
        display:
          name: Infrastructure provider
          hidden: true
        value: "N/A"
  panels:
    # Overview Stats
    systemHealth:
      kind: Panel
      spec:
        display:
          name: System health
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  # Healthy nodes / Total nodes
                  query: count(max by (node) (kube_node_status_condition{condition="Ready",status="true"} == 1)) / count(max by (node) (kube_node_status_condition{condition="Ready",status="true"}))
                  seriesNameFormat: System health
    deployedModels:
      kind: Panel
      spec:
        display:
          name: Deployed models
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              decimalPlaces: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  # Count unique models by model_name and namespace from vLLM metrics
                  query: count(group(kserve_vllm:num_requests_running) by (model_name, namespace))
                  seriesNameFormat: Deployed models
    gpuUtilizationStat:
      kind: Panel
      spec:
        display:
          name: GPU utilization
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: percent
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  query: avg(accelerator_gpu_utilization)
                  seriesNameFormat: GPU usage
    # successRate:
    #   kind: Panel
    #   spec:
    #     display:
    #       name: Request success rate
    #     plugin:
    #       kind: StatChart
    #       spec:
    #         calculation: last-number
    #         format:
    #           unit: percent-decimal
    #           decimalPlaces: 1
    #     queries:
    #       - kind: TimeSeriesQuery
    #         spec:
    #           plugin:
    #             kind: PrometheusTimeSeriesQuery
    #             spec:
    #               datasource:
    #                 kind: PrometheusDatasource
    #               # Request success rate using totals
    #               query: vector(-999)
    #               seriesNameFormat: Success rate
    # Cluster-wide usage - Area charts
    gpuUtilizationArea:
      kind: Panel
      spec:
        display:
          name: GPU utilization
        plugin:
          kind: TimeSeriesChart
          spec:
            visual:
              areaOpacity: 0.6
              connectNulls: false
              display: line
              lineWidth: 1.5
            yAxis:
              format:
                unit: percent
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  query: avg(accelerator_gpu_utilization)
                  seriesNameFormat: GPU usage
    memoryUtilizationArea:
      kind: Panel
      spec:
        display:
          name: Memory allocated
        plugin:
          kind: TimeSeriesChart
          spec:
            visual:
              areaOpacity: 0.6
              connectNulls: false
              display: line
              lineWidth: 1.5
            yAxis:
              format:
                unit: percent-decimal
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  query: sum(container_memory_working_set_bytes{container!="", image!=""}) / sum(node_memory_MemTotal_bytes)
                  seriesNameFormat: Memory allocated
    cpuUtilizationArea:
      kind: Panel
      spec:
        display:
          name: CPU utilization
        plugin:
          kind: TimeSeriesChart
          spec:
            visual:
              areaOpacity: 0.6
              connectNulls: false
              display: line
              lineWidth: 1.5
            yAxis:
              format:
                unit: percent-decimal
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  query: sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate) / sum(kube_node_status_allocatable{resource="cpu"})
                  seriesNameFormat: CPU usage
    networkUtilizationArea:
      kind: Panel
      spec:
        display:
          name: Inbound traffic
        plugin:
          kind: TimeSeriesChart
          spec:
            visual:
              areaOpacity: 0.6
              connectNulls: false
              display: line
              lineWidth: 1.5
            yAxis:
              format:
                unit: bytes
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  # Network receive rate in bytes/second
                  query: sum(rate(container_network_receive_bytes_total[$__rate_interval]))
                  seriesNameFormat: Network
    gpuUtilizationByProject:
      kind: Panel
      spec:
        display:
          name: GPU utilization
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
              values: []
            visual:
              areaOpacity: 1
              connectNulls: false
              display: line
              lineWidth: 0.25
              stack: all
            yAxis:
              format:
                unit: percent
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  query: avg by (namespace) (accelerator_gpu_utilization{namespace=~"$namespace"})
                  seriesNameFormat: "{{namespace}}"
    cpuUtilizationByProject:
      kind: Panel
      spec:
        display:
          name: CPU utilization
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
              values: []
            visual:
              areaOpacity: 1
              connectNulls: false
              display: line
              lineWidth: 0.25
              stack: all
            yAxis:
              format:
                unit: percent-decimal
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  # CPU usage by namespace as percentage of total cluster allocatable CPU
                  query: sum by (namespace) (node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=~"$namespace"}) / scalar(sum(kube_node_status_allocatable{resource="cpu"}))
                  seriesNameFormat: "{{namespace}}"
    memoryUsageByProject:
      kind: Panel
      spec:
        display:
          name: Memory allocated
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
              values: []
            visual:
              areaOpacity: 1
              connectNulls: false
              display: line
              lineWidth: 0.25
              stack: all
            yAxis:
              format:
                unit: percent-decimal
              min: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                  # Memory allocated by namespace as percentage of total cluster memory
                  query: sum by (namespace) (container_memory_working_set_bytes{namespace=~"$namespace", container!="", image!=""}) / scalar(sum(node_memory_MemTotal_bytes))
                  seriesNameFormat: "{{namespace}}"
    # Cluster Details - Static Markdown Panel
    clusterDetails:
      kind: Panel
      spec:
        display:
          name: Cluster details
        plugin:
          kind: Markdown
          spec:
            text: |
              <dl class="pf-v6-c-description-list pf-m-auto-column-widths pf-m-horizontal">
                <div class="pf-v6-c-description-list__group">
                  <dt class="pf-v6-c-description-list__term">
                    <span class="pf-v6-c-description-list__text">Provider</span>
                  </dt>
                  <dd class="pf-v6-c-description-list__description">
                    <div class="pf-v6-c-description-list__text">${CLUSTER_DETAILS_INFRASTRUCTURE_PROVIDER}</div>
                  </dd>
                </div>
                <div class="pf-v6-c-description-list__group">
                  <dt class="pf-v6-c-description-list__term">
                    <span class="pf-v6-c-description-list__text">OpenShift version</span>
                  </dt>
                  <dd class="pf-v6-c-description-list__description">
                    <div class="pf-v6-c-description-list__text">${CLUSTER_DETAILS_OPENSHIFT_VERSION}</div>
                  </dd>
                </div>
                <div class="pf-v6-c-description-list__group">
                  <dt class="pf-v6-c-description-list__term">
                    <span class="pf-v6-c-description-list__text">Channel</span>
                  </dt>
                  <dd class="pf-v6-c-description-list__description">
                    <div class="pf-v6-c-description-list__text">${CLUSTER_DETAILS_CHANNEL}</div>
                  </dd>
                </div>
                <div class="pf-v6-c-description-list__group">
                  <dt class="pf-v6-c-description-list__term">
                    <span class="pf-v6-c-description-list__text">API server</span>
                  </dt>
                  <dd class="pf-v6-c-description-list__description">
                    <div class="pf-v6-c-description-list__text">${CLUSTER_DETAILS_API_SERVER}</div>
                  </dd>
                </div>
              </dl>
  layouts:
    # Overview Section - Stats Row
    - kind: Grid
      spec:
        display:
          title: Overview
          collapse:
            open: true
        items:
          - x: 0
            'y': 0
            width: 8
            height: 4
            content:
              '$ref': '#/spec/panels/systemHealth'
          - x: 8
            'y': 0
            width: 8
            height: 4
            content:
              '$ref': '#/spec/panels/deployedModels'
          - x: 16
            'y': 0
            width: 8
            height: 4
            content:
              '$ref': '#/spec/panels/gpuUtilizationStat'
          # - x: 18
          #   'y': 0
          #   width: 6
          #   height: 4
          #   content:
          #     '$ref': '#/spec/panels/successRate'
    # Cluster-wide usage section
    - kind: Grid
      spec:
        display:
          title: Cluster resource overview
          collapse:
            open: true
        items:
          - x: 0
            'y': 0
            width: 12
            height: 8
            content:
              '$ref': '#/spec/panels/gpuUtilizationArea'
          - x: 12
            'y': 0
            width: 12
            height: 8
            content:
              '$ref': '#/spec/panels/memoryUtilizationArea'
          - x: 0
            'y': 8
            width: 12
            height: 8
            content:
              '$ref': '#/spec/panels/cpuUtilizationArea'
          - x: 12
            'y': 8
            width: 12
            height: 8
            content:
              '$ref': '#/spec/panels/networkUtilizationArea'
    # Project resource usage Section
    - kind: Grid
      spec:
        display:
          title: Project resource usage
          collapse:
            open: true
        items:
          - x: 0
            'y': 0
            width: 8
            height: 10
            content:
              '$ref': '#/spec/panels/gpuUtilizationByProject'
          - x: 8
            'y': 0
            width: 8
            height: 10
            content:
              '$ref': '#/spec/panels/cpuUtilizationByProject'
          - x: 16
            'y': 0
            width: 8
            height: 10
            content:
              '$ref': '#/spec/panels/memoryUsageByProject'
    # Cluster Details Section
    - kind: Grid
      spec:
        display:
          title: Cluster details
          collapse:
            open: true
        items:
          - x: 0
            'y': 0
            width: 24
            height: 8
            content:
              '$ref': '#/spec/panels/clusterDetails'
