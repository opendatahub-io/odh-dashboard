name: Sync Main to ODH Release

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: odh-release
          fetch-depth: 0
          # Uses automatic GITHUB_TOKEN - no manual secrets needed!

      - name: Merge main into odh-release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main

          # Attempt merge, handle .env conflicts by keeping odh-release version
          if git merge origin/main -m "Auto-merge main into odh-release"; then
            echo "Merge completed successfully"
          else
            echo "Merge conflict detected, resolving..."
            
            # Check if frontend/.env has conflicts and resolve by keeping ours (odh-release)
            if git diff --name-only --diff-filter=U | grep -q "frontend/.env"; then
              echo "Resolving frontend/.env conflict - keeping odh-release version"
              git checkout --ours frontend/.env
              git add frontend/.env
            fi
            
            # Check for any remaining unresolved conflicts
            if git diff --name-only --diff-filter=U | grep -v "frontend/.env" | grep -q .; then
              echo "ERROR: Unresolved conflicts in files other than frontend/.env:"
              git diff --name-only --diff-filter=U
              exit 1
            fi
            
            # Complete the merge
            git commit -m "Auto-merge main into odh-release (resolved .env conflict)"
          fi

          git push origin odh-release

  upversion:
    needs: sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Determine new version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest -odh release tag and increment z-stream
          LATEST_ODH_TAG=$(gh release list --repo="${{ github.repository }}" --limit 100 | grep -E 'v[0-9]+\.[0-9]+\.[0-9]+-odh' | head -1 | awk '{print $1}')

          if [ -z "$LATEST_ODH_TAG" ]; then
            echo "ERROR: Could not find any existing -odh release tags"
            exit 1
          fi

          echo "Latest ODH release tag: $LATEST_ODH_TAG"

          # Extract version without -odh suffix (e.g., v3.0.2-odh -> v3.0.2)
          VERSION_WITHOUT_SUFFIX="${LATEST_ODH_TAG%-odh}"

          # Get current version from frontend/.env for comparison
          CURRENT_VERSION=$(grep 'INTERNAL_DASHBOARD_VERSION=' frontend/.env | cut -d'=' -f2)
          echo "Current version in .env: $CURRENT_VERSION"

          # Remove 'v' prefix and split
          VERSION_NO_V="${VERSION_WITHOUT_SUFFIX#v}"
          MAJOR=$(echo "$VERSION_NO_V" | cut -d'.' -f1)
          MINOR=$(echo "$VERSION_NO_V" | cut -d'.' -f2)
          PATCH=$(echo "$VERSION_NO_V" | cut -d'.' -f3)

          # Increment z-stream (patch version)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "New version: $NEW_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create upversion branch and update files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="upversion-${{ steps.version.outputs.new_version }}"
          git checkout -b "$BRANCH_NAME"

          OLD_VERSION="${{ steps.version.outputs.current_version }}"
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Update frontend/.env
          sed -i "s/INTERNAL_DASHBOARD_VERSION=.*/INTERNAL_DASHBOARD_VERSION=${NEW_VERSION}/" frontend/.env

          # Update manifests/modular-architecture/params.env (if version tags exist)
          sed -i "s/${OLD_VERSION}-odh/${NEW_VERSION}-odh/g" manifests/modular-architecture/params.env

          # Update manifests/odh/params.env (if version tags exist)
          sed -i "s/${OLD_VERSION}-odh/${NEW_VERSION}-odh/g" manifests/odh/params.env

          # Commit and push
          git add frontend/.env manifests/modular-architecture/params.env manifests/odh/params.env
          git commit -m "Upversion dashboard to ${NEW_VERSION}"
          git push origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLD_VERSION: ${{ steps.version.outputs.current_version }}
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          PR_BODY="## Description

          Upversion dashboard from \`${OLD_VERSION}\` to \`${NEW_VERSION}\`.

          ### Changes
          - Updated \`INTERNAL_DASHBOARD_VERSION\` in \`frontend/.env\`
          - Updated image tags in \`manifests/modular-architecture/params.env\`
          - Updated image tags in \`manifests/odh/params.env\`

          ---
          *This PR was automatically created by the Sync Main to ODH Release workflow.*"

          gh pr create \
            --base main \
            --head "${{ env.branch_name }}" \
            --title "Upversion Dashboard" \
            --body "$PR_BODY"

  release-notes:
    needs: sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout odh-release
        uses: actions/checkout@v4
        with:
          ref: odh-release
          fetch-depth: 0

      - name: Determine version for release
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest -odh release tag and increment z-stream
          LATEST_ODH_TAG=$(gh release list --repo="${{ github.repository }}" --limit 100 | grep -E 'v[0-9]+\.[0-9]+\.[0-9]+-odh' | head -1 | awk '{print $1}')

          if [ -z "$LATEST_ODH_TAG" ]; then
            echo "ERROR: Could not find any existing -odh release tags"
            exit 1
          fi

          echo "Latest ODH release tag: $LATEST_ODH_TAG"

          # Extract version without -odh suffix (e.g., v3.0.2-odh -> v3.0.2)
          VERSION_WITHOUT_SUFFIX="${LATEST_ODH_TAG%-odh}"

          # Remove 'v' prefix and split
          VERSION_NO_V="${VERSION_WITHOUT_SUFFIX#v}"
          MAJOR=$(echo "$VERSION_NO_V" | cut -d'.' -f1)
          MINOR=$(echo "$VERSION_NO_V" | cut -d'.' -f2)
          PATCH=$(echo "$VERSION_NO_V" | cut -d'.' -f3)

          # Increment z-stream (patch version)
          NEW_PATCH=$((PATCH + 1))
          RELEASE_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}-odh"

          echo "New release tag: $RELEASE_TAG"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Create Tag and Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.release_tag }}" \
            --repo="${{ github.repository }}" \
            --title="${{ steps.version.outputs.release_tag }}" \
            --target="odh-release" \
            --latest=false \
            --generate-notes
