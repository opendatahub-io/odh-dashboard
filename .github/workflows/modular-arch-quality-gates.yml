---
name: Modular Architecture - Quality Gates

on:
  pull_request:
    paths:
      - 'frontend/packages/**'
  workflow_dispatch:
    inputs:
      modules:
        description: 'Space-separated module names to run (optional)'
        required: false
        type: string

permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '20'
  GO_VERSION: '1.24.3'

jobs:
  detect-changes:
    name: Detect Module Changes
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.check-changes.outputs.has-changes }}
      changed-modules: ${{ steps.check-changes.outputs.changed-modules }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: check-changes
        run: |
          set -euo pipefail
          CHANGED_FILES=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "Fetching files changed in PR #$PR_NUMBER"
            # Paginate through changed files (in case > 100)
            PAGE=1
            while : ; do
              RESP=$(curl -sS -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files?per_page=100&page=$PAGE")
              PAGE_FILES=$(echo "$RESP" | jq -r '.[].filename')
              [ -z "$PAGE_FILES" ] && break
              CHANGED_FILES="$CHANGED_FILES $PAGE_FILES"
              PAGE=$((PAGE+1))
            done
            CHANGED_FILES=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep "^frontend/packages/" | cut -d'/' -f3 | sort -u | tr '\n' ' ' | sed 's/ $//')
          else
            # workflow_dispatch path: allow manual override via input
            if [ -n "${{ github.event.inputs.modules }}" ]; then
              CHANGED_FILES="${{ github.event.inputs.modules }}"
            else
              echo "No PR context and no modules input; nothing to do"
            fi
          fi
          
          echo "Changed modules: '$CHANGED_FILES'"
          
          # Include only structurally valid modules (no hardcoded names)
          FILTERED_MODULES=""
          for mod in $CHANGED_FILES; do
            base="frontend/packages/$mod"
            if [ -d "$base/upstream/frontend" ] || [ -d "$base/upstream/bff" ] || [ -d "$base/src" ] || [ -d "$base/bff" ]; then
              if [ -z "$FILTERED_MODULES" ]; then
                FILTERED_MODULES="$mod"
              else
                FILTERED_MODULES="$FILTERED_MODULES $mod"
              fi
              echo "Including module (structurally valid): $mod"
            else
              echo "Skipping non-module structure: $mod"
            fi
          done

          if [ -n "$FILTERED_MODULES" ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "changed-modules=$FILTERED_MODULES" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi

  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate test matrix
        id: generate-matrix
        run: |
          # Use the detected modules from previous job output
          CHANGED_MODULES="${{ needs.detect-changes.outputs.changed-modules }}"
          
          echo "Generating matrix for modules: '$CHANGED_MODULES'"
          
          # Build JSON array from space-separated string
          JSON_ARRAY="["
          FIRST=true
          for module in $CHANGED_MODULES; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON_ARRAY="$JSON_ARRAY,"
            fi
            JSON_ARRAY="$JSON_ARRAY\"$module\""
          done
          JSON_ARRAY="$JSON_ARRAY]"
          
          echo "Generated matrix: $JSON_ARRAY"
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

  

  # Quality Gate 2: Application Quality Gate
  application-quality-gate:
    name: Application Quality Gate
    runs-on: ubuntu-latest
    needs: [detect-changes, generate-matrix]
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        module: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for silent mode configuration
        id: check-config
        run: |
          CONFIG_FILE="frontend/packages/${{ matrix.module }}/.quality-gates-config.yml"
          if [ -f "$CONFIG_FILE" ] && grep -q "silent_notifications: true" "$CONFIG_FILE"; then
            echo "üîï Silent mode enabled for ${{ matrix.module }}"
            echo "silent_mode=true" >> $GITHUB_OUTPUT
          else
            echo "üîî Silent mode disabled for ${{ matrix.module }}"
            echo "silent_mode=false" >> $GITHUB_OUTPUT
          fi

      - name: Assess Testing Maturity
        run: |
          MODULE_PATH="frontend/packages/${{ matrix.module }}"
          FRONTEND_PATH="$MODULE_PATH/upstream/frontend"
          
          echo "üéØ Assessing testing maturity for ${{ matrix.module }}"
          
          IMPLEMENTED_CHECKS=0
          MISSING_CHECKS=()
          TOTAL_CHECKS=6
          
          # Check 1: Unit Tests - Look in both module-specific and global test directories
          UNIT_TESTS_FOUND=false
          UNIT_FOUND_PATH=""
          
          # Check for unit tests in module's own structure
          if [ -n "$(find "$MODULE_PATH" -path "*/__tests__/unit/*" -name "*.test.*" -o -path "*/__tests__/unit/*" -name "*.spec.*" 2>/dev/null | head -1)" ]; then
            UNIT_TESTS_FOUND=true
            UNIT_FOUND_PATH="$MODULE_PATH"
          fi
          
          # Check module's upstream frontend for tests (excluding e2e/mocked)
          if [ "$UNIT_TESTS_FOUND" = false ] && [ -d "$FRONTEND_PATH" ]; then
            # Find __tests__ directories that are NOT e2e or mocked
            TEST_DIRS=$(find "$FRONTEND_PATH" -name "*__tests__*" -type d 2>/dev/null | grep -v "/e2e" | grep -v "/mocked")
            for test_dir in $TEST_DIRS; do
              UNIT_TEST_FILES=$(find "$test_dir" -type f \( -name "*.test.*" -o -name "*.spec.*" \) 2>/dev/null)
              if [ -n "$UNIT_TEST_FILES" ]; then
              UNIT_TESTS_FOUND=true
              UNIT_FOUND_PATH="$test_dir"
                break
              fi
            done
          fi
          
          # Check for unit tests in global frontend test directory  
          if [ "$UNIT_TESTS_FOUND" = false ] && [ -d "frontend/src/__tests__/unit/" ]; then
            # Check for files with module name patterns
            MODULE_PATTERNS=(
              "${{ matrix.module }}"                        # exact: model-registry
              "$(echo ${{ matrix.module }} | sed 's/-//g')" # no hyphens: modelregistry
            )
            for pattern in "${MODULE_PATTERNS[@]}"; do
              UNIT_FILES=$(find "frontend/src/__tests__/unit/" -type f -name "*${pattern}*" 2>/dev/null)
              if [ -n "$UNIT_FILES" ]; then
              UNIT_TESTS_FOUND=true
              UNIT_FOUND_PATH="frontend/src/__tests__/unit/"
                break
              fi
            done
          fi
          
          if [ "$UNIT_TESTS_FOUND" = true ]; then
            echo "‚úÖ Unit Tests - PRESENT"
            if [ -n "$UNIT_FOUND_PATH" ]; then
              echo "   üìÅ Found unit tests in: $UNIT_FOUND_PATH"
            fi
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå Unit Tests - MISSING"
            MISSING_CHECKS+=("Unit tests")
          fi
          
          # Check 2: E2E Tests - Look for module-specific e2e directories  
          E2E_TESTS_FOUND=false
          E2E_BASE_DIR="frontend/src/__tests__/cypress/cypress/tests/e2e"
          
          # Build module name patterns dynamically
          RAW_MODULE="${{ matrix.module }}"
          MODULE_NO_HYPHENS=$(echo "$RAW_MODULE" | sed 's/-//g')
          # module to camelCase (best-effort: split on '-')
          MODULE_CAMEL=$(echo "$RAW_MODULE" | awk -F'-' '{for(i=1;i<=NF;i++){if(i==1){printf $i}else{printf toupper(substr($i,1,1)) substr($i,2)}}}')
          MODULE_PATTERNS=("$RAW_MODULE" "$MODULE_NO_HYPHENS" "$MODULE_CAMEL")
          
          E2E_FOUND_PATH=""
          for pattern in "${MODULE_PATTERNS[@]}"; do
            if [ -d "$E2E_BASE_DIR/$pattern" ] && [ -n "$(find "$E2E_BASE_DIR/$pattern" -type f -name "*.cy.ts" 2>/dev/null | head -1)" ]; then
              E2E_TESTS_FOUND=true
              E2E_FOUND_PATH="$E2E_BASE_DIR/$pattern"
              break
            fi
          done
          
          # Also check module's own cypress structure
          if [ "$E2E_TESTS_FOUND" = false ] && [ -n "$(find "$MODULE_PATH" -path "*/cypress/tests/e2e/*" -type f -name "*.cy.ts" 2>/dev/null | head -1)" ]; then
            E2E_TESTS_FOUND=true
            E2E_FOUND_PATH="$MODULE_PATH/cypress/tests/e2e/"
          fi
          
          if [ "$E2E_TESTS_FOUND" = true ]; then
            echo "‚úÖ E2E Tests - PRESENT"
            if [ -n "$E2E_FOUND_PATH" ]; then
              echo "   üìÅ Found E2E tests in: $E2E_FOUND_PATH"
            fi
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå E2E Tests - MISSING"
            MISSING_CHECKS+=("End-to-end tests")
          fi
          
          # Check 3: Mock Tests
          MOCK_TESTS_FOUND=false
          # Check module's own cypress structure for mock tests
          if [ -n "$(find "$MODULE_PATH" -path "*/cypress/tests/mocked/*" -type f -name "*.cy.ts" 2>/dev/null | head -1)" ]; then
            MOCK_TESTS_FOUND=true
          fi
          # Check global mocked tests directory
          if [ -d "frontend/src/__tests__/cypress/cypress/tests/mocked/" ]; then
            MODULE_PATTERNS=(
              "${{ matrix.module }}"                        # exact: model-registry
              "$(echo ${{ matrix.module }} | sed 's/-//g')" # no hyphens: modelregistry
            )
            for pattern in "${MODULE_PATTERNS[@]}"; do
              if [ -n "$(find "frontend/src/__tests__/cypress/cypress/tests/mocked/" -name "*${pattern}*" 2>/dev/null | head -1)" ]; then
                MOCK_TESTS_FOUND=true
                break
              fi
            done
          fi
          
          if [ "$MOCK_TESTS_FOUND" = true ]; then
            echo "‚úÖ Mock Tests - PRESENT"
            # Show where mock tests were found
            if [ -n "$(find "$MODULE_PATH" -path "*/cypress/tests/mocked/*" -type f -name "*.cy.ts" 2>/dev/null | head -1)" ]; then
              echo "   üìÅ Found mock tests in: $MODULE_PATH/cypress/tests/mocked/"
            else
              echo "   üìÅ Found mock tests in: frontend/src/__tests__/cypress/cypress/tests/mocked/"
            fi
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå Mock Tests - MISSING"
            MISSING_CHECKS+=("Mock tests")
          fi
          
          # Check 4: Pact Testing (files only, grouped predicates)
          PACT_FILE=$(find "$MODULE_PATH" -type f \( -iname "*pact*" -o -iname "*contract*" \) 2>/dev/null | head -1)
          if [ -n "$PACT_FILE" ]; then
            echo "‚úÖ Pact Testing - PRESENT"
            echo "   üìÅ Found Pact tests in: $(dirname "$PACT_FILE")"
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå Pact Testing - MISSING"
            MISSING_CHECKS+=("API contract testing (Pact)")
          fi
          
          # Check 5: API Functional Testing
          API_FUNC_FOUND=false
          API_FUNC_PATH=""
          # Cypress-based API tests in global structure (scoped by module patterns)
          API_BASE_DIR="frontend/src/__tests__/cypress/cypress/tests/api"
          if [ -d "$API_BASE_DIR" ]; then
            for pattern in "${MODULE_PATTERNS[@]}"; do
              if [ -d "$API_BASE_DIR/$pattern" ] && [ -n "$(find "$API_BASE_DIR/$pattern" -type f -name "*.cy.*" 2>/dev/null | head -1)" ]; then
                API_FUNC_FOUND=true
                API_FUNC_PATH="$API_BASE_DIR/$pattern"
                break
              fi
              # accept -api or Api suffixed
              if [ -d "$API_BASE_DIR/${pattern}-api" ] && [ -n "$(find "$API_BASE_DIR/${pattern}-api" -type f -name "*.cy.*" 2>/dev/null | head -1)" ]; then
                API_FUNC_FOUND=true
                API_FUNC_PATH="$API_BASE_DIR/${pattern}-api"
                break
              fi
              if [ -d "$API_BASE_DIR/${pattern}Api" ] && [ -n "$(find "$API_BASE_DIR/${pattern}Api" -type f -name "*.cy.*" 2>/dev/null | head -1)" ]; then
                API_FUNC_FOUND=true
                API_FUNC_PATH="$API_BASE_DIR/${pattern}Api"
                break
              fi
            done
          fi
          # Module cypress api tests (scoped)
          if [ "$API_FUNC_FOUND" = false ]; then
            if [ -n "$(find "$MODULE_PATH" -path "*/cypress/tests/api*/*" -type f -name "*.cy.*" 2>/dev/null | head -1)" ]; then
              # Prefer subdir matching module patterns if present
              FOUND=""
              for pattern in "${MODULE_PATTERNS[@]}"; do
                CANDIDATE="$MODULE_PATH/cypress/tests/api/$pattern"
                if [ -d "$CANDIDATE" ] && [ -n "$(find "$CANDIDATE" -type f -name "*.cy.*" 2>/dev/null | head -1)" ]; then
                  FOUND="$CANDIDATE"
                  break
                fi
              done
              if [ -n "$FOUND" ]; then
                API_FUNC_FOUND=true
                API_FUNC_PATH="$FOUND"
              else
                API_FUNC_FOUND=true
                API_FUNC_PATH="$MODULE_PATH/cypress/tests/"
              fi
            fi
          fi
          # Jest-style API tests in frontend (scoped by module patterns in path or filename)
          if [ "$API_FUNC_FOUND" = false ] && [ -d "$FRONTEND_PATH/src/__tests__" ]; then
            API_JEST_FILE=$(find "$FRONTEND_PATH/src/__tests__" -type f \( -path "*/api/*" -o -name "*.api.test.*" -o -name "*.api.spec.*" \) 2>/dev/null | grep -E "$(printf '%s|' "${MODULE_PATTERNS[@]}" | sed 's/|$//')" | head -1)
            if [ -n "$API_JEST_FILE" ]; then
              API_FUNC_FOUND=true
              API_FUNC_PATH=$(dirname "$API_JEST_FILE")
            fi
          fi

          # Shared tests under frontend/packages (scoped by module patterns, excluding non-modules by structure)
          if [ "$API_FUNC_FOUND" = false ] && [ -d "frontend/packages" ]; then
            SHARED_API_PATH=$(find frontend/packages -type d \( -path "*/src/__tests__/api/*" -o -path "*/cypress/tests/api*/*" \) 2>/dev/null \
              | awk -F'/frontend/packages/' '{print $2}' | awk -F'/' 'NF{print $1"/"$0}' \
              | while read rel; do mod=$(echo "$rel" | cut -d'/' -f1); base="frontend/packages/$mod"; \
                  if [ -d "$base/upstream/frontend" ] || [ -d "$base/upstream/bff" ] || [ -d "$base/src" ] || [ -d "$base/bff" ]; then echo "$rel"; fi; done \
              | sed 's#^#frontend/packages/#' \
              | grep -E "$(printf '%s|' "${MODULE_PATTERNS[@]}" | sed 's/|$//')" \
              | head -1)
            if [ -n "$SHARED_API_PATH" ]; then
              API_FUNC_FOUND=true
              API_FUNC_PATH="$SHARED_API_PATH"
            fi
          fi
          if [ "$API_FUNC_FOUND" = true ]; then
            echo "‚úÖ API Functional Testing - PRESENT"
            echo "   üìÅ Found API functional tests in: $API_FUNC_PATH"
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå API Functional Testing - MISSING"
            MISSING_CHECKS+=("API functional tests")
          fi
          
          # Check 6: API Performance Testing (files only, grouped predicates)
          PERF_FILE=$(find "$MODULE_PATH" -type f \( -iname "*k6*" -o -iname "*jmeter*" -o -iname "*performance*" \) 2>/dev/null | head -1)
          if [ -n "$PERF_FILE" ]; then
            echo "‚úÖ API Performance Testing - PRESENT"
            echo "   üìÅ Found API performance tests in: $(dirname "$PERF_FILE")"
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå API Performance Testing - MISSING"
            MISSING_CHECKS+=("API performance testing")
          fi
          
          # Check 7: Bundle Size Monitoring
          if [ -f "$FRONTEND_PATH/package.json" ] && grep -qE '"size-limit|bundlewatch"' "$FRONTEND_PATH/package.json"; then
            echo "‚úÖ Bundle Size Monitoring - PRESENT"
            echo "   üìÅ Found bundle size config in: $FRONTEND_PATH/package.json"
            IMPLEMENTED_CHECKS=$((IMPLEMENTED_CHECKS + 1))
          else
            echo "‚ùå Bundle Size Monitoring - MISSING"
            MISSING_CHECKS+=("Bundle size monitoring")
          fi

          # Accessibility testing check removed entirely
          
          # Calculate percentage
          # Update total checks to reflect categories (Unit, E2E, Mock, Pact, API Functional, API Performance, Bundle Size)
          TOTAL_CHECKS=7
          PERCENTAGE=$((IMPLEMENTED_CHECKS * 100 / TOTAL_CHECKS))
          
          echo ""
          echo "üìä Testing Maturity Assessment:"
          echo "   Implemented: $IMPLEMENTED_CHECKS/$TOTAL_CHECKS ($PERCENTAGE%)"
          
          # RHOAI Quality Thresholds
          if [ $PERCENTAGE -ge 75 ]; then
            echo "   üéØ RHOAI Quality Threshold: ‚úÖ PASSED ($PERCENTAGE% >= 75%)"
          else
            echo "   üéØ RHOAI Quality Threshold: ‚ùå NEEDS IMPROVEMENT ($PERCENTAGE% < 75%)"
            echo ""
            echo "üìã Recommendations for RHOAI readiness:"
            for check in "${MISSING_CHECKS[@]}"; do
              echo "   ‚Ä¢ Implement $check"
            done
          fi
          
          if [ $IMPLEMENTED_CHECKS -ge 2 ]; then
            echo "   üìà Good foundation: Multiple test categories implemented"
          fi

          # Write a per-module detailed block to include in the final summary
          OUT_DIR="$GITHUB_WORKSPACE/app-gate"
          mkdir -p "$OUT_DIR"
          OUT_FILE="$OUT_DIR/${{ matrix.module }}.md"

          echo "Run MODULE_PATH=\"$MODULE_PATH\"" > "$OUT_FILE"
          echo "üéØ Assessing testing maturity for ${{ matrix.module }}" >> "$OUT_FILE"

          # Unit
          if [ "$UNIT_TESTS_FOUND" = true ]; then
            echo "‚úÖ Unit Tests - PRESENT" >> "$OUT_FILE"
            if [ -n "$UNIT_FOUND_PATH" ]; then
              echo "   üìÅ Found unit tests in: $UNIT_FOUND_PATH" >> "$OUT_FILE"
            fi
          else
            echo "‚ùå Unit Tests - MISSING" >> "$OUT_FILE"
          fi

          # E2E
          if [ "$E2E_TESTS_FOUND" = true ]; then
            echo "‚úÖ E2E Tests - PRESENT" >> "$OUT_FILE"
            if [ -n "$E2E_FOUND_PATH" ]; then
              echo "   üìÅ Found E2E tests in: $E2E_FOUND_PATH" >> "$OUT_FILE"
            fi
          else
            echo "‚ùå E2E Tests - MISSING" >> "$OUT_FILE"
          fi

          # Mock
          if [ "$MOCK_TESTS_FOUND" = true ]; then
            echo "‚úÖ Mock Tests - PRESENT" >> "$OUT_FILE"
            if [ -n "$(find "$MODULE_PATH" -path "*/cypress/tests/mocked/*" -name "*.cy.*" 2>/dev/null | head -1)" ]; then
              echo "   üìÅ Found mock tests in: $MODULE_PATH/cypress/tests/mocked/" >> "$OUT_FILE"
            else
              echo "   üìÅ Found mock tests in: frontend/src/__tests__/cypress/cypress/tests/mocked/" >> "$OUT_FILE"
            fi
          else
            echo "‚ùå Mock Tests - MISSING" >> "$OUT_FILE"
          fi

          # Pact
          if [ -n "$PACT_FILE" ]; then
            echo "‚úÖ Pact Testing - PRESENT" >> "$OUT_FILE"
          else
            echo "‚ùå Pact Testing - MISSING" >> "$OUT_FILE"
          fi

          # API Functional
          if [ "$API_FUNC_FOUND" = true ]; then
            echo "‚úÖ API Functional Testing - PRESENT" >> "$OUT_FILE"
            if [ -n "$API_FUNC_PATH" ]; then
              echo "   üìÅ Found API functional tests in: $API_FUNC_PATH" >> "$OUT_FILE"
            fi
          else
            echo "‚ùå API Functional Testing - MISSING" >> "$OUT_FILE"
          fi

          # API Performance
          if [ -n "$PERF_FILE" ]; then
            echo "‚úÖ API Performance Testing - PRESENT" >> "$OUT_FILE"
            echo "   üìÅ Found API performance tests in: $(dirname "$PERF_FILE")" >> "$OUT_FILE"
          else
            echo "‚ùå API Performance Testing - MISSING" >> "$OUT_FILE"
          fi

          # Bundle Size
          if [ -f "$FRONTEND_PATH/package.json" ] && grep -qE '"size-limit|bundlewatch"' "$FRONTEND_PATH/package.json"; then
            echo "‚úÖ Bundle Size Monitoring - PRESENT" >> "$OUT_FILE"
            echo "   üìÅ Found bundle size config in: $FRONTEND_PATH/package.json" >> "$OUT_FILE"
          else
            echo "‚ùå Bundle Size Monitoring - MISSING" >> "$OUT_FILE"
          fi

          echo "" >> "$OUT_FILE"
          echo "üìä Testing Maturity Assessment:" >> "$OUT_FILE"
          echo "   Implemented: $IMPLEMENTED_CHECKS/$TOTAL_CHECKS ($PERCENTAGE%)" >> "$OUT_FILE"
          if [ $PERCENTAGE -ge 75 ]; then
            echo "   üéØ RHOAI Quality Threshold: ‚úÖ PASSED ($PERCENTAGE% >= 75%)" >> "$OUT_FILE"
          else
            echo "   üéØ RHOAI Quality Threshold: ‚ùå NEEDS IMPROVEMENT ($PERCENTAGE% < 75%)" >> "$OUT_FILE"
          fi
          echo "" >> "$OUT_FILE"
          echo "üìã Recommendations for RHOAI readiness:" >> "$OUT_FILE"
          for check in "${MISSING_CHECKS[@]}"; do
            echo "   ‚Ä¢ Implement $check" >> "$OUT_FILE"
          done
          if [ $IMPLEMENTED_CHECKS -ge 2 ]; then
            echo "   üìà Good foundation: Multiple test categories implemented" >> "$OUT_FILE"
          fi

      - name: Upload per-module assessment
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-gate-${{ matrix.module }}
          path: ${{ github.workspace }}/app-gate/*.md
          if-no-files-found: ignore

  

  

  quality-gates-summary:
    name: Quality Gates Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, application-quality-gate]
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    steps:
      - name: Download per-module assessments
        uses: actions/download-artifact@v4
        with:
          pattern: app-gate-*
          merge-multiple: true
          path: ${{ github.workspace }}/app-gate

      - name: Generate Quality Gates Summary
        run: |
          echo "üìä Generating Quality Gates Summary..."
          
          # Build comprehensive quality gates summary
          SUMMARY_FILE="quality-gates-summary.md"
          
          echo "## üö¶ Modular Architecture Quality Gates Results" > $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          # Assessment only; omit pass/fail copy
          
          
          
          echo "### üéØ Changed Modules" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          for mod in ${{ needs.detect-changes.outputs.changed-modules }}; do
            echo "- $mod" >> $SUMMARY_FILE
          done
          echo "" >> $SUMMARY_FILE

          echo "### üß™ Assess Testing Maturity (details)" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          if [ -d "$GITHUB_WORKSPACE/app-gate" ]; then
            for f in "$GITHUB_WORKSPACE"/app-gate/*.md; do
              [ -f "$f" ] || continue
              echo '```' >> $SUMMARY_FILE
              cat "$f" >> $SUMMARY_FILE
              echo '```' >> $SUMMARY_FILE
              echo "" >> $SUMMARY_FILE
            done
          else
            echo "(no assessments found)" >> $SUMMARY_FILE
          fi
          
          echo "### üìö Resources" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "- [Modular Architecture Guide](https://github.com/opendatahub-io/odh-dashboard/blob/main/docs/modular-architecture.md)" >> $SUMMARY_FILE
          echo "- [Quality Gates Documentation](https://github.com/opendatahub-io/odh-dashboard/blob/main/docs/modular-architecture-quality-gates.md)" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "---" >> $SUMMARY_FILE
          echo "*Generated by ODH Dashboard Modular Architecture Quality Gates*" >> $SUMMARY_FILE
          
          # Log to step summary
          cat $SUMMARY_FILE >> $GITHUB_STEP_SUMMARY
          
          echo "‚úÖ Summary generated and logged to step summary"

      - name: Upload summary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: quality-gates-summary
          path: quality-gates-summary.md

      # PR comments handled by helper workflow (workflow_run)

