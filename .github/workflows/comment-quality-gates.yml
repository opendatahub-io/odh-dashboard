name: Comment Quality Gates Summary

on:
  workflow_run:
    workflows: ["Modular Architecture - Quality Gates"]
    types:
      - completed

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  comment-pr:
    name: Post Quality Gates Summary
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' && (github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure') }}
    steps:
      - name: Debug workflow run info
        run: |
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          
      - name: Download Quality Gates Summary
        uses: actions/download-artifact@v4
        with:
          name: quality-gates-summary
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get PR number from workflow run
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR number from the workflow run
            const pullRequests = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: '${{ github.event.workflow_run.head_sha }}'
            });
            
            if (pullRequests.data.length === 0) {
              console.log('‚ùå No PR found for this workflow run');
              return;
            }
            
            const prNumber = pullRequests.data[0].number;
            console.log('üìã Found PR #' + prNumber);
            core.setOutput('pr-number', prNumber);
            return prNumber;

      - name: Read quality gates summary
        id: read-summary
        run: |
          if [ -f "quality-gates-summary.md" ]; then
            echo "‚úÖ Found quality gates summary file"
            echo "summary-exists=true" >> $GITHUB_OUTPUT
            # Read content and escape for output
            summary_content=$(cat quality-gates-summary.md)
            echo "summary-content<<EOF" >> $GITHUB_OUTPUT
            echo "$summary_content" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Quality gates summary file not found"
            echo "summary-exists=false" >> $GITHUB_OUTPUT
            echo "summary-content<<EOF" >> $GITHUB_OUTPUT
            echo "## üö¶ Quality Gates Summary" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "‚ùå Unable to load summary content. Please check the workflow logs." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post or update PR comment
        if: steps.get-pr.outputs.pr-number
        uses: mshick/add-pr-comment@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          issue: ${{ steps.get-pr.outputs.pr-number }}
          message: ${{ steps.read-summary.outputs.summary-content }}
          message-id: "quality-gates-summary"
          message-failure: |
            ## üö¶ Quality Gates Summary
            
            ‚ùå Unable to post quality gates summary. Please check the workflow logs for details.